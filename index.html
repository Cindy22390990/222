<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ€¨å®…ï¼šç¬¬13é›™çœ¼ç› (é‡è£½ç‰ˆ)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');

        body {
            background-color: #050505;
            color: #dcdcdc;
            font-family: 'Noto Serif TC', serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            height: 100vh;
            background: #000;
            position: relative;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #222;
            border-right: 1px solid #222;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
        }

        /* Vignette Effect */
        .vignette {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 150px rgba(0,0,0,1);
            pointer-events: none;
            z-index: 5;
            transition: box-shadow 2s;
        }

        .blood-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(180, 0, 0, 0.6) 100%);
            opacity: 0;
            pointer-events: none;
            z-index: 6;
            transition: opacity 0.5s;
        }

        /* Scene Area */
        #scene-area {
            flex: 1;
            padding: 40px 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            scrollbar-width: none; /* Firefox */
        }
        #scene-area::-webkit-scrollbar { display: none; } /* Chrome */

        .location-title {
            color: #555;
            font-size: 0.9rem;
            letter-spacing: 3px;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid #222;
            padding-bottom: 10px;
            text-transform: uppercase;
        }

        .story-text {
            font-size: 1.1rem;
            line-height: 1.9;
            margin-bottom: 20px;
            text-align: justify;
            transition: color 0.3s;
            color: #bbb;
        }

        .highlight {
            color: #c0392b;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(192, 57, 43, 0.3);
        }

        .clue {
            color: #f39c12;
            font-weight: bold;
            border-bottom: 1px dotted #f39c12;
        }

        /* Inventory */
        #inventory-bar {
            height: 70px;
            background: #0f0f0f;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            overflow-x: auto;
        }

        .inv-item {
            width: 45px;
            height: 45px;
            background: #1a1a1a;
            border: 1px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4rem;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }
        
        .inv-item:hover {
            border-color: #777;
            background: #2a2a2a;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            color: #fff;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
            z-index: 20;
            border: 1px solid #444;
        }

        /* Choice Buttons */
        #choices-area {
            padding: 20px;
            background: #080808;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 10;
        }

        .choice-btn {
            background: linear-gradient(90deg, transparent 0%, rgba(20,20,20,0.5) 100%);
            border: 1px solid #333;
            border-left: 3px solid #333;
            color: #999;
            padding: 15px 20px;
            font-size: 1rem;
            font-family: 'Noto Serif TC', serif;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .choice-btn:hover {
            background: #151515;
            border-left-color: #c0392b;
            color: #fff;
            padding-left: 25px;
        }

        .choice-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-left-color: #333;
        }

        /* Puzzle Input */
        #puzzle-container {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            background: #111;
            padding: 15px;
            border: 1px solid #333;
        }
        
        #puzzle-input {
            background: #000;
            border: 1px solid #444;
            color: #c0392b;
            padding: 10px;
            font-family: monospace;
            font-size: 1.2rem;
            text-align: center;
            letter-spacing: 5px;
        }

        #puzzle-submit {
            background: #333;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
        
        #puzzle-submit:hover {
            background: #c0392b;
        }

        /* Animations */
        @keyframes flicker {
            0% { opacity: 1; } 3% { opacity: 0.1; } 6% { opacity: 1; }
            7% { opacity: 0.1; } 9% { opacity: 1; } 100% { opacity: 1; }
        }
        .flicker-text { animation: flicker 4s infinite; }

        @keyframes shake {
            0% { transform: translate(0, 0); }
            20% { transform: translate(-3px, 3px); }
            40% { transform: translate(3px, -3px); }
            60% { transform: translate(-3px, 0); }
            80% { transform: translate(3px, 0); }
            100% { transform: translate(0, 0); }
        }
        .shake-screen { animation: shake 0.4s ease-in-out; }

        /* Ending Screen */
        #end-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
            opacity: 0; pointer-events: none;
            transition: opacity 3s;
            padding: 40px;
            box-sizing: border-box;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="vignette"></div>
        <div class="blood-overlay" id="blood-fx"></div>

        <div id="scene-area">
            <div class="location-title" id="location-text">åºç« </div>
            <div class="story-text" id="story-text">
                ï¼ˆè¼‰å…¥ä¸­...ï¼‰
            </div>
            
            <div id="puzzle-container">
                <input type="text" id="puzzle-input" placeholder="CODE" maxlength="4">
                <button id="puzzle-submit" onclick="submitPuzzle()">è¼¸å…¥</button>
            </div>
        </div>

        <div id="inventory-bar"></div>
        <div class="tooltip" id="tooltip"></div>

        <div id="choices-area"></div>
        
        <div id="end-overlay">
            <h1 id="end-title" style="color: #c0392b; font-size: 2rem;">çµå±€</h1>
            <p id="end-desc" style="color: #aaa; margin: 20px 0;">...</p>
            <button class="choice-btn" onclick="location.reload()" style="margin-top:20px; text-align:center;">é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <script>
        // --- Game Data ---
        const state = {
            scene: 'start',
            inventory: [],
            flags: {}
        };

        const items = {
            'flashlight': { name: 'æ‰‹é›»ç­’', icon: 'ğŸ”¦', desc: 'é›–ç„¶å¾®å¼±ï¼Œä½†èƒ½ç…§äº®é»‘æš—ã€‚' },
            'key_basement': { name: 'åœ°ä¸‹å®¤é‘°åŒ™', icon: 'ğŸ—ï¸', desc: 'ä¸€æŠŠç”Ÿé½çš„èˆŠé‘°åŒ™ã€‚' },
            'crowbar': { name: 'æ’¬æ£', icon: 'ğŸ¥–', desc: 'å …å›ºçš„éµæ’¬ï¼Œå¯ä»¥æ’¬é–‹é–€æˆ–ç®±å­ã€‚' },
            'tape': { name: 'çµ•ç·£è† å¸¶', icon: 'âš«', desc: 'é»‘è‰²è† å¸¶ï¼Œä¿®å¾©é›»ç·šå¿…å‚™ã€‚' },
            'fuse': { name: 'ä¿éšªçµ²', icon: 'ğŸ”‹', desc: 'æ–°çš„ä¿éšªçµ²ï¼Œè¦æ ¼ä¼¼ä¹ç¬¦åˆå¤§é–€é…é›»ç®±ã€‚' },
            'note_fragment': { name: 'å¯†ç¢¼ç´™æ¢', icon: 'ğŸ“„', desc: 'ä¸Šé¢å¯«è‘—è¬é¡Œçš„æç¤ºã€‚' }
        };

        // Scene Definitions
        const scenes = {
            // --- Basement ---
            'start': {
                loc: 'åœ°ä¸‹å®¤',
                text: 'åŠ‡çƒˆçš„é ­ç—›è®“ä½ å¾æ˜è¿·ä¸­é†’ä¾†ã€‚ä½ èººåœ¨ä¸€å¼µå†°å†·çš„æ‰‹è¡“å°ä¸Šã€‚<br>ç©ºæ°£ä¸­ç€°æ¼«è‘—ç¦é¦¬æ—å’Œéµé½çš„å‘³é“ã€‚å”¯ä¸€çš„å…‰æºæ˜¯é ­é ‚æ–æ–æ¬²å¢œçš„ç‡ˆæ³¡ã€‚<br>é–€é‚Šæœ‰ä¸€å€‹ç”Ÿé½çš„éµæ«ƒï¼Œé–€è¢«é–æ­»äº†ã€‚',
                choices: [
                    { text: 'èª¿æŸ¥éµæ«ƒ', next: 'cabinet' },
                    { text: 'èª¿æŸ¥éµé–€', next: 'door_locked' },
                    { text: 'æŸ¥çœ‹æ‰‹è¡“å°', next: 'operating_table' }
                ]
            },
            'operating_table': {
                loc: 'åœ°ä¸‹å®¤',
                text: 'æ‰‹è¡“å°ä¸Šæ®˜ç•™è‘—ä¹¾æ¶¸çš„è¡€è·¡å’ŒæŸç¸›å¸¶ã€‚åœ¨æ•é ­ä¸‹é¢ï¼Œä½ æ‘¸åˆ°äº†ä¸€å€‹å†°å†·çš„é‡‘å±¬ç‰©é«”ã€‚<br>ç²å¾—äº†<span class="clue">åœ°ä¸‹å®¤é‘°åŒ™</span>ã€‚',
                action: () => addItem('key_basement'),
                choices: [
                    { text: 'å›å»', next: 'start' }
                ]
            },
            'cabinet': {
                loc: 'åœ°ä¸‹å®¤',
                text: 'éµæ«ƒè£¡å †æ»¿äº†ä»¤äººä½œå˜”çš„æ‰‹è¡“å™¨å…·ï¼šéª¨é‹¸ã€æ‰‹è¡“åˆ€ã€é‡ç­’...<br>åœ¨åº•å±¤çš„æ¶å­ä¸Šï¼Œä½ æ‰¾åˆ°äº†ä¸€å€‹é‚„èƒ½ç”¨çš„<span class="clue">æ‰‹é›»ç­’</span>ã€‚',
                action: () => addItem('flashlight'),
                choices: [
                    { text: 'æ‰“é–‹æ‰‹é›»ç­’ç…§äº®å››å‘¨', next: 'basement_lit' }
                ]
            },
            'basement_lit': {
                loc: 'åœ°ä¸‹å®¤',
                text: 'æ‰‹é›»ç­’çš„å…‰æŸæƒéç‰†å£ã€‚ä½ çœ‹è¦‹ç‰†ä¸Šå¯†å¯†éº»éº»åœ°åˆ»æ»¿äº†æŒ‡ç”²æŠ“ç—•ã€‚<br>ã€Œ<span class="highlight">çˆ¸çˆ¸åœ¨èªªè¬Š</span>ã€ã€Œ<span class="highlight">ä¸è¦çœ‹é¡å­</span>ã€ã€Œ<span class="highlight">æ•‘å‘½</span>ã€<br>é€™äº›å­—è·¡è®“ä½ èƒŒè„Šç™¼æ¶¼ã€‚',
                choices: [
                    { text: 'å˜—è©¦ç”¨é‘°åŒ™é–‹é–€', cond: () => has('key_basement'), next: 'door_open' },
                    { text: 'å›åˆ°é»‘æš—ä¸­', next: 'start' }
                ]
            },
            'door_locked': {
                loc: 'åœ°ä¸‹å®¤',
                text: 'éµé–€ç·Šé–ã€‚é–å­”é½è·¡æ–‘æ–‘ã€‚ä½ éœ€è¦é‘°åŒ™ã€‚',
                choices: [
                    { text: 'å›é ­æ‰¾æ‰¾', next: 'start' }
                ]
            },
            'door_open': {
                loc: 'åœ°ä¸‹å®¤',
                text: 'é‘°åŒ™åœ¨é–å­”è£¡ç™¼å‡ºåˆºè€³çš„æ‘©æ“¦è²ï¼Œã€Œå–€åš“ã€ä¸€è²ï¼Œé–€é–‹äº†ã€‚<br>èµ°å»Šçš„å†·é¢¨å¹äº†é€²ä¾†ï¼Œå¸¶è‘—ä¸€è‚¡è…æ•—çš„æ°£å‘³ã€‚',
                choices: [
                    { text: 'é›¢é–‹åœ°ä¸‹å®¤', next: 'corridor' }
                ]
            },

            // --- Corridor ---
            'corridor': {
                loc: 'ä¸€æ¨“èµ°å»Š',
                text: 'èµ°å»Šå…©å´æ›è‘—æ­·ä»£ä¸»äººçš„è‚–åƒç•«ï¼Œä½†ä»–å€‘çš„çœ¼ç›éƒ½è¢«æƒ¡æ„æŒ–æ‰äº†ã€‚<br>å·¦é‚Šæ˜¯<span class="clue">å»šæˆ¿</span>ï¼Œå³é‚Šæ˜¯ä¸€æ‰‡è¢«æœ¨æ¿å°æ­»çš„é–€ï¼ˆä¼¼ä¹æ˜¯<span class="clue">æµ´å®¤</span>ï¼‰ï¼Œå‰æ–¹æ˜¯<span class="clue">æ›¸æˆ¿</span>ã€‚<br>èµ°å»Šç›¡é ­æ˜¯<span class="clue">å¤§é–€</span>ã€‚',
                choices: [
                    { text: 'å‰å¾€å»šæˆ¿', next: 'kitchen' },
                    { text: 'æŸ¥çœ‹å°æ­»çš„æµ´å®¤é–€', next: 'bathroom_door' },
                    { text: 'å‰å¾€æ›¸æˆ¿', next: 'study' },
                    { text: 'å‰å¾€å¤§é–€', next: 'main_door' }
                ]
            },

            // --- Kitchen ---
            'kitchen': {
                loc: 'è…æ•—å»šæˆ¿',
                text: 'å»šæˆ¿æµç†å°ä¸Šå †æ»¿äº†ç™¼éœ‰çš„é¤å…·ã€‚åœ°ä¸Šæœ‰ä¸€å¤§ç˜æ—©å·²ä¹¾æ¶¸çš„é»‘è‰²æ±¡æ¼¬ã€‚<br>å†°ç®±é–€åŠé–‹è‘—ï¼Œç™¼å‡ºå—¡å—¡è²ã€‚è§’è½çš„å·¥å…·æ¶ä¸Šä¼¼ä¹æœ‰äº›æ±è¥¿ã€‚',
                choices: [
                    { text: 'æª¢æŸ¥å·¥å…·æ¶', next: 'kitchen_tools' },
                    { text: 'æŸ¥çœ‹å†°ç®±', next: 'kitchen_fridge' },
                    { text: 'å›åˆ°èµ°å»Š', next: 'corridor' }
                ]
            },
            'kitchen_tools': {
                loc: 'è…æ•—å»šæˆ¿',
                text: 'å·¥å…·æ¶ä¸Šå¤§éƒ¨åˆ†å·¥å…·éƒ½ä¸è¦‹äº†ï¼Œåªå‰©ä¸‹ä¸€å·<span class="clue">çµ•ç·£è† å¸¶</span>ã€‚<br>é‚„æœ‰ï¼Œåœ¨æ´—æ‰‹å°ä¸‹æ–¹ï¼Œä½ ç™¼ç¾äº†ä¸€æ ¹<span class="clue">æ’¬æ£</span>å¡åœ¨æ°´ç®¡ç¸«éš™è£¡ã€‚',
                action: () => { addItem('tape'); addItem('crowbar'); },
                choices: [
                    { text: 'æ‹¿èµ°ç‰©å“', next: 'kitchen' }
                ]
            },
            'kitchen_fridge': {
                loc: 'è…æ•—å»šæˆ¿',
                text: 'ä½ æ‹‰é–‹å†°ç®±ï¼Œä¸€è‚¡æƒ¡è‡­æ’²é¢è€Œä¾†ã€‚<br>è£¡é¢æ²’æœ‰é£Ÿç‰©ï¼Œåªæœ‰ä¸€é¡†è…çˆ›çš„è±¬é ­ï¼ˆå¸Œæœ›é‚£æ˜¯è±¬é ­ï¼‰ã€‚<br>è±¬é ­çš„å˜´è£¡å¡è‘—ä¸€å¼µç´™æ¢ï¼Œå¯«è‘—ï¼šã€Œ<span class="highlight">æµ´å®¤çš„é¡å­çœ‹è¦‹äº†çœŸç›¸</span>ã€ã€‚',
                choices: [
                    { text: 'é—œä¸Šå†°ç®±', next: 'kitchen' }
                ]
            },

            // --- Bathroom (Puzzle Chain Start) ---
            'bathroom_door': {
                loc: 'èµ°å»Š',
                text: 'æµ´å®¤çš„é–€è¢«å¹¾æ ¹åšæœ¨æ¿é‡˜æ­»äº†ã€‚è£¡é¢å‚³ä¾†æ»´ç­”æ»´ç­”çš„æ°´è²ã€‚',
                choices: [
                    { text: 'ä½¿ç”¨æ’¬æ£æ’¬é–‹', cond: () => has('crowbar'), next: 'bathroom_enter' },
                    { text: 'é›¢é–‹', next: 'corridor' }
                ]
            },
            'bathroom_enter': {
                loc: 'è¡€è…¥æµ´å®¤',
                text: 'æœ¨æ¿è¢«æ’¬é–‹ï¼Œç™¼å‡ºå·¨å¤§çš„ç¢è£‚è²ã€‚<br>æµ´å®¤è£¡å……æ»¿äº†ç†±æ°£ï¼Ÿä¸ï¼Œæ˜¯å¯’æ°£å‡çµçš„éœ§ã€‚<br>æµ´ç¼¸è£¡è£æ»¿äº†æš—ç´…è‰²çš„æ¶²é«”ï¼Œç‰†ä¸Šçš„é¡å­è¢«æ°´æ°£è¦†è“‹ã€‚',
                choices: [
                    { text: 'æ“¦æ‹­é¡å­', next: 'bathroom_mirror' },
                    { text: 'æª¢æŸ¥æµ´ç¼¸', next: 'bathroom_tub' },
                    { text: 'å›åˆ°èµ°å»Š', next: 'corridor' }
                ]
            },
            'bathroom_mirror': {
                loc: 'è¡€è…¥æµ´å®¤',
                text: 'ä½ ç”¨æ‰‹æ“¦å»é¡å­ä¸Šçš„æ°´æ°£ã€‚<br>é¡å­ä¸Šé¡¯ç¾å‡ºå¹¾å€‹è¡€ç´…è‰²çš„æ•¸å­—ï¼š<br><br><span class="highlight" style="font-size: 2rem; letter-spacing: 10px;">7 3 9</span><br><br>é€™ä¼¼ä¹æ˜¯æŸç¨®å¯†ç¢¼ã€‚',
                choices: [
                    { text: 'è¨˜ä½å¯†ç¢¼', next: 'bathroom_enter' }
                ]
            },
            'bathroom_tub': {
                loc: 'è¡€è…¥æµ´å®¤',
                text: 'æµ´ç¼¸è£¡çš„è¡€æ°´æ·±ä¸è¦‹åº•ã€‚ä½ éš±ç´„çœ‹è¦‹æ°´åº•æœ‰æ±è¥¿ã€‚<br>ä½ å¿…é ˆä¼¸æ‰‹é€²å»...<br>ä½ æ·±å¸ä¸€å£æ°£ï¼Œå°‡æ‰‹ä¼¸å…¥å†°å†·çš„è¡€æ°´ä¸­ã€‚',
                effect: 'shake', // small scare
                text_append: '<br>å¦‚æœä½ å†æ‘¸ç´¢ä¹…ä¸€é»ï¼Œå¥½åƒæœ‰éš»æ‰‹æŠ“ä½äº†ä½ ï¼<br>ä½ çŒ›åœ°æŠ½å›æ‰‹ï¼Œä»€éº¼éƒ½æ²’æœ‰ã€‚ä½†ä½ ä¸¦æ²’æœ‰æ‰¾åˆ°ä»»ä½•æ±è¥¿ã€‚çœ‹ä¾†é€™è£¡åªæ˜¯åš‡å”¬äººçš„ã€‚',
                choices: [
                    { text: 'é€€å¾Œ', next: 'bathroom_enter' }
                ]
            },

            // --- Study (Puzzle Chain Mid) ---
            'study': {
                loc: 'æ›¸æˆ¿',
                text: 'æ›¸æˆ¿è£¡æ›¸æ¶å€’å¡Œï¼Œæ»¿åœ°ç‹¼è—‰ã€‚æ¡Œä¸Šæœ‰ä¸€æœ¬æ—¥è¨˜ã€‚<br>ç‰†è§’æœ‰ä¸€å€‹<span class="clue">å°å‹ä¿éšªç®±</span>ï¼Œéœ€è¦è¼¸å…¥ä¸‰ä½æ•¸å¯†ç¢¼ã€‚',
                choices: [
                    { text: 'é–±è®€æ—¥è¨˜', next: 'study_diary' },
                    { text: 'å˜—è©¦é–‹å•Ÿä¿éšªç®±', next: 'safe_puzzle' },
                    { text: 'å›åˆ°èµ°å»Š', next: 'corridor' }
                ]
            },
            'study_diary': {
                loc: 'æ›¸æˆ¿',
                text: 'æ—¥è¨˜æœ¬ï¼šã€Œ12æœˆ24æ—¥ã€‚å¯¦é©—å¤±æ•—äº†ã€‚å…’å­è®Šå¾—ä¸å†æ˜¯ä»–äº†...ä»–æ®ºäº†åª½åª½ã€‚ã€<br>ã€Œæˆ‘æŠŠå¤§é–€çš„é›»å­é–å¯†ç¢¼è¨­ç‚ºäº†é‚£è©²æ­»çš„å¯¦é©—ä»£è™Ÿã€‚æç¤ºå°±åœ¨æˆ‘çš„ç•«ä½œè£¡ã€‚ã€<br>ã€Œ<span class="highlight">çœ¼ç› x æ‰‹æŒ‡ + 10</span>ã€',
                choices: [
                    { text: 'æ”¾ä¸‹æ—¥è¨˜', next: 'study' }
                ]
            },
            'safe_puzzle': {
                loc: 'æ›¸æˆ¿',
                text: 'ä¿éšªç®±ä¸Šæœ‰ä¸€å€‹æ•¸å­—è½‰ç›¤ã€‚éœ€è¦ä¸‰å€‹æ•¸å­—ã€‚',
                puzzle: { answer: '739', next: 'safe_open' },
                choices: [
                    { text: 'è¼¸å…¥å¯†ç¢¼', action: 'puzzle' },
                    { text: 'æ”¾æ£„', next: 'study' }
                ]
            },
            'safe_open': {
                loc: 'æ›¸æˆ¿',
                text: 'ã€Œå–€ã€ä¸€è²ï¼Œä¿éšªç®±æ‰“é–‹äº†ã€‚<br>è£¡é¢æ”¾è‘—ä¸€å€‹å…¨æ–°çš„<span class="clue">ä¿éšªçµ²</span>ã€‚<br>é€™æ­£æ˜¯å¤§é–€é…é›»ç®±ç¼ºå°‘çš„é›¶ä»¶ï¼',
                action: () => addItem('fuse'),
                choices: [
                    { text: 'æ‹¿èµ°ä¿éšªçµ²', next: 'study' }
                ]
            },

            // --- Main Door (Final Puzzle) ---
            'main_door': {
                loc: 'å¤§é–€',
                text: 'åšé‡çš„é‡‘å±¬å¤§é–€æ˜¯é€šå¾€è‡ªç”±çš„å”¯ä¸€è·¯å¾‘ã€‚<br>æ—é‚Šçš„é…é›»ç®±å¤–è“‹æ‰“é–‹è‘—ï¼Œè£¡é¢çš„é›»ç·šè¢«å‰ªæ–·äº†ï¼Œè€Œä¸”ç¼ºå°‘ä¿éšªçµ²ã€‚<br>é›»å­é–å±å¹•æ˜¯é»‘çš„ã€‚',
                choices: [
                    { text: 'ä¿®ç†é…é›»ç®±', next: 'fix_box_check' },
                    { text: 'å›åˆ°èµ°å»Š', next: 'corridor' }
                ]
            },
            'fix_box_check': {
                loc: 'å¤§é–€é…é›»ç®±',
                text: 'ä½ éœ€è¦ä¿®å¾©é›»è·¯ã€‚ä½ éœ€è¦ï¼š<br>1. é€£æ¥æ–·æ‰çš„é›»ç·šã€‚<br>2. å®‰è£æ–°çš„ä¿éšªçµ²ã€‚',
                choices: [
                    { text: 'ä½¿ç”¨çµ•ç·£è† å¸¶æ¥ç·š', cond: () => has('tape') && !state.flags.wired, action: () => state.flags.wired = true, next: 'fix_box_process' },
                    { text: 'å®‰è£ä¿éšªçµ²', cond: () => has('fuse') && !state.flags.fused, action: () => state.flags.fused = true, next: 'fix_box_process' },
                    { text: 'å•Ÿå‹•é›»æº', cond: () => state.flags.wired && state.flags.fused, next: 'door_power_on' },
                    { text: 'é‚„ç¼ºææ–™', cond: () => !has('tape') || !has('fuse'), next: 'corridor' }
                ]
            },
            'fix_box_process': {
                loc: 'å¤§é–€é…é›»ç®±',
                text: 'ä½ æ­£åœ¨ä¿®ç†é…é›»ç®±...<br>å³ä½¿æ‰‹åœ¨ç™¼æŠ–ï¼Œä½ é‚„æ˜¯å®Œæˆäº†æ“ä½œã€‚',
                choices: [
                    { text: 'ç¹¼çºŒä¿®ç†', next: 'fix_box_check' }
                ]
            },
            'door_power_on': {
                loc: 'å¤§é–€',
                text: 'éš¨è‘—é›»æµè²éŸ¿èµ·ï¼Œé›»å­é–çš„ç´…ç‡ˆäº®äº†ï¼<br>å±å¹•é¡¯ç¤ºï¼šã€Œè¼¸å…¥å¯¦é©—ä»£è™Ÿã€ã€‚<br>æç¤ºå›æƒ³ï¼šæ—¥è¨˜è£¡å¯«è‘—ã€Œ<span class="highlight">çœ¼ç› x æ‰‹æŒ‡ + 10</span>ã€ã€‚<br>ï¼ˆæç¤ºï¼šèµ°å»Šæœ‰3å¹…è‚–åƒç•«ï¼Œæ¯å¹…ç•«2éš»çœ¼ç›ï¼Œå…±6éš»ã€‚äººæœ‰10æ ¹æ‰‹æŒ‡ã€‚ï¼‰',
                // Calculation: (6 eyes * 10 fingers) + 10 = 70.
                puzzle: { answer: '70', next: 'escape' }, 
                choices: [
                    { text: 'è¼¸å…¥å¯†ç¢¼', action: 'puzzle' },
                    { text: 'å†æƒ³æƒ³', next: 'corridor' }
                ]
            },
            'escape': {
                loc: 'çµå±€',
                text: 'å¯†ç¢¼æ­£ç¢ºã€‚ã€Œå—¶ã€çš„ä¸€è²é•·éŸ³ï¼Œå¤§é–€è§£é–äº†ã€‚<br>ä½ æ¨é–‹æ²‰é‡çš„å¤§é–€ï¼Œå¤–é¢çš„æš´é›¨æ‰“åœ¨ä½ çš„è‡‰ä¸Šã€‚<br>ä½ æ‹¼å‘½åœ°è·‘ï¼Œèº«å¾Œå®…é‚¸è£¡ä¼¼ä¹å‚³ä¾†äº†æ†¤æ€’çš„å’†å“®è²ï¼Œä½†ä½ å†ä¹Ÿæ²’æœ‰å›é ­ã€‚',
                ending: { title: 'ç”Ÿé‚„è€…', desc: 'ä½ æˆåŠŸé€ƒé›¢äº†æ€¨å®…ï¼ŒçµæŸäº†é€™å ´å™©å¤¢ã€‚' }
            }
        };

        // --- Core Functions ---

        function has(itemId) {
            return state.inventory.includes(itemId);
        }

        function addItem(itemId) {
            if (!has(itemId)) {
                state.inventory.push(itemId);
                renderInventory();
                showTooltip(`ç²å¾—ï¼š${items[itemId].name}`);
            }
        }

        function showTooltip(text) {
            const el = document.getElementById('tooltip');
            el.innerText = text;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 3000);
        }

        function renderInventory() {
            const bar = document.getElementById('inventory-bar');
            bar.innerHTML = '';
            state.inventory.forEach(id => {
                const item = items[id];
                const el = document.createElement('div');
                el.className = 'inv-item';
                el.innerText = item.icon;
                
                // Tooltip on hover
                el.onmouseenter = () => showTooltip(item.name + ": " + item.desc);
                el.onmouseleave = () => document.getElementById('tooltip').style.opacity = 0;
                
                bar.appendChild(el);
            });
        }

        function renderScene(sceneId) {
            const scene = scenes[sceneId];
            if (!scene) return console.error('Scene missing:', sceneId);

            state.scene = sceneId;

            // Update UI
            document.getElementById('location-text').innerText = scene.loc;
            
            // Handle append text if refreshing scene
            const textEl = document.getElementById('story-text');
            textEl.innerHTML = scene.text + (scene.text_append || '');
            delete scene.text_append; // Clear append after showing once

            // Effects
            const container = document.getElementById('game-container');
            container.className = ''; // Reset classes
            if (scene.effect === 'shake') {
                container.classList.add('shake-screen');
                document.getElementById('blood-fx').style.opacity = 0.8;
                setTimeout(() => document.getElementById('blood-fx').style.opacity = 0, 500);
            }

            // Actions
            if (scene.action && typeof scene.action === 'function') {
                scene.action();
            }

            // Ending?
            if (scene.ending) {
                document.getElementById('end-overlay').style.opacity = 1;
                document.getElementById('end-overlay').style.pointerEvents = 'auto';
                document.getElementById('end-title').innerText = scene.ending.title;
                document.getElementById('end-desc').innerText = scene.ending.desc;
                return;
            }

            // Render Choices or Puzzle
            const choicesArea = document.getElementById('choices-area');
            const puzzleDiv = document.getElementById('puzzle-container');
            choicesArea.innerHTML = '';
            puzzleDiv.style.display = 'none';

            if (scene.puzzle && scene.choices.find(c => c.action === 'puzzle')) {
                // Puzzle Mode
                window.currentPuzzle = scene.puzzle;
                document.getElementById('puzzle-input').value = '';
                
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = 'è¼¸å…¥å¯†ç¢¼';
                btn.onclick = () => {
                    puzzleDiv.style.display = 'flex';
                    choicesArea.style.display = 'none';
                    document.getElementById('puzzle-input').focus();
                };
                choicesArea.appendChild(btn);

                const backBtn = document.createElement('button');
                backBtn.className = 'choice-btn';
                backBtn.innerText = 'è¿”å›';
                backBtn.onclick = () => {
                     // Find the non-puzzle exit
                     const exit = scene.choices.find(c => c.action !== 'puzzle');
                     if(exit) renderScene(exit.next);
                };
                choicesArea.appendChild(backBtn);

            } else {
                // Normal Choice Mode
                choicesArea.style.display = 'flex';
                scene.choices.forEach(c => {
                    if (c.cond && !c.cond()) return; // Skip if condition not met

                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.innerText = c.text;
                    if (c.action && typeof c.action === 'function') {
                        btn.onclick = () => { c.action(); renderScene(c.next); };
                    } else {
                        btn.onclick = () => renderScene(c.next);
                    }
                    choicesArea.appendChild(btn);
                });
            }
        }

        // Puzzle Logic
        function submitPuzzle() {
            const input = document.getElementById('puzzle-input');
            const val = input.value.trim();
            const puzzle = window.currentPuzzle;
            const choicesArea = document.getElementById('choices-area');
            const puzzleDiv = document.getElementById('puzzle-container');

            if (val === puzzle.answer) {
                puzzleDiv.style.display = 'none';
                choicesArea.style.display = 'flex';
                renderScene(puzzle.next);
            } else {
                input.value = '';
                input.placeholder = 'éŒ¯èª¤';
                document.getElementById('game-container').classList.add('shake-screen');
                setTimeout(() => document.getElementById('game-container').classList.remove('shake-screen'), 500);
            }
        }

        // Init
        renderScene('start');

    </script>
</body>
</html>